<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Empresa — Postulaciones</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/app.css">
</head>
<body>
  <header>
    <a class="btn ghost" href="/employer-jobs.html">Vacantes</a>
    <div class="spacer"></div>
    <button id="logoutBtn" class="btn ghost">Salir</button>
  </header>

  <main class="container">
    <h2>Postulaciones</h2>
    <section class="card">
      <div class="grid" style="grid-template-columns:1fr 220px 180px auto;gap:10px">
        <input id="q" type="search" placeholder="Buscar por usuario/empleo/estado…">
        <select id="byJob"><option value="">Todos los empleos</option></select>
        <select id="byStatus">
          <option value="">Todos los estados</option>
          <option>Pendiente</option><option>Revisando</option><option>Rechazado</option><option>Aceptado</option>
        </select>
        <div style="display:flex;gap:8px">
          <button id="refreshBtn" class="btn ghost">Actualizar</button>
          <button id="exportBtn" class="btn">Exportar CSV</button>
        </div>
      </div>

      <div style="display:flex; gap:12px; flex-wrap:wrap; margin-top:12px">
        <span id="countAll" class="status">Total: 0</span>
        <span id="countPend" class="status Pendiente">Pendiente: 0</span>
        <span id="countRev"  class="status Revisando">Revisando: 0</span>
        <span id="countRej"  class="status Rechazado">Rechazado: 0</span>
        <span id="countAcp"  class="status Aceptado">Aceptado: 0</span>
      </div>

      <div class="tableWrap" style="margin-top:12px">
        <table><thead><tr><th>ID</th><th>Usuario</th><th>Email</th><th>Empleo</th><th>Estado</th><th>Fecha</th><th>CV/Imagen</th></tr></thead><tbody id="tbody"></tbody></table>
      </div>
      <p id="msg" class="msg"></p>
    </section>
  </main>

  <script src="/assets/app.js"></script>
  <script>
    const {requireRole,qs,escapeHtml,fmtDate,fetchJSON} = App;
    requireRole('EMPLOYER','ADMIN'); App.wireHeader();

    const q=qs('#q'), byJob=qs('#byJob'), byStatus=qs('#byStatus'), tbody=qs('#tbody'), msg=qs('#msg');
    const cAll=qs('#countAll'),cPend=qs('#countPend'),cRev=qs('#countRev'),cRej=qs('#countRej'),cAcp=qs('#countAcp');
    let all=[], jobs=[];

    function setMsg(t,e=false){ msg.textContent=t||''; msg.classList.toggle('err',!!e) }
    function counters(list){ cAll.textContent=`Total: ${list.length}`; cPend.textContent=`Pendiente: ${list.filter(x=>x.status==='Pendiente').length}`; cRev.textContent=`Revisando: ${list.filter(x=>x.status==='Revisando').length}`; cRej.textContent=`Rechazado: ${list.filter(x=>x.status==='Rechazado').length}`; cAcp.textContent=`Aceptado: ${list.filter(x=>x.status==='Aceptado').length}`; }
    function render(){
      const term=(q.value||'').toLowerCase(), jid=byJob.value, st=byStatus.value;
      const filtered=all.filter(a=>{
        const uname=(a.user?.name||'').toLowerCase(), email=(a.user?.email||'').toLowerCase(), jtitle=(a.job?.title||'').toLowerCase(), s=(a.status||'').toLowerCase();
        const okTerm=!term||uname.includes(term)||email.includes(term)||jtitle.includes(term)||s.includes(term);
        const okJob=!jid||String(a.job&&(a.job.id_job??a.job.id))===String(jid);
        const okSt=!st||a.status===st; return okTerm&&okJob&&okSt;
      });
      counters(filtered); tbody.innerHTML=''; if(!filtered.length){ setMsg('Sin resultados'); return; }
      setMsg(`Total filtrado: ${filtered.length}`);
      for(const a of filtered){
        tbody.insertAdjacentHTML('beforeend', `<tr>
          <td>${a.id_application??a.id??''}</td>
          <td>${escapeHtml(a.user?.name||'')}</td>
          <td><a href="mailto:${encodeURIComponent(a.user?.email||'')}">${escapeHtml(a.user?.email||'')}</a></td>
          <td>${escapeHtml(a.job?.title||'')}</td>
          <td><span class="status ${escapeHtml(a.status||'Pendiente')}">${escapeHtml(a.status||'Pendiente')}</span></td>
          <td>${escapeHtml(fmtDate(a.applied_at||a.appliedAt))}</td>
          <td>${a.url_img?`<a href="${escapeHtml(a.url_img)}" target="_blank">Abrir</a>`:''}</td>
        </tr>`);
      }
    }

    async function load(){
      setMsg('Cargando…'); tbody.innerHTML='<tr><td colspan="7"><div class="skeleton"></div></td></tr>';
      try{
        jobs=await fetchJSON('/api/jobs');
        byJob.innerHTML='<option value="">Todos los empleos</option>'+jobs.map(j=>`<option value="${j.id_job??j.id}">${escapeHtml((j.title||'')+' — '+(j.companyDisplay||j.company||''))}</option>`).join('');
        all = await fetchJSON('/api/applications'); render();
      }catch(e){ setMsg('❌ '+e.message,true); }
    }

    qs('#refreshBtn').onclick=load; q.oninput=render; byJob.onchange=render; byStatus.onchange=render;
    qs('#exportBtn').onclick=()=>{ if(!all.length) return; const rows=[['id','user_name','user_email','job_title','status','applied_at','url_img'],...all.map(a=>[a.id_application??a.id??'',a.user?.name||'',a.user?.email||'',a.job?.title||'',a.status||'',fmtDate(a.applied_at||a.appliedAt)||'',a.url_img||''])]; const csv=rows.map(r=>r.map(c=>{const s=String(c??'');return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s}).join(',')).join('\n'); const blob=new Blob([csv],{type:'text/csv'}),url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url;a.download='postulaciones.csv';a.click();URL.revokeObjectURL(url); };

    load();
  </script>
  <script src="/assets/app.js"></script>
</body>
</html>
