<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Empresa — Vacantes</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/app.css">
  <style>
    /* Layout vertical para las dos tarjetas */
    .stack-vertical{ display:grid; grid-template-columns: 1fr; gap:16px; }
    /* (Opcional) si quieres volver a 2 columnas en pantallas grandes, descomenta:
    @media (min-width: 1100px){
      .stack-vertical{ grid-template-columns: 1fr; } 
      -- Mantener 1 columna siempre, como pediste.
      -- Si quisieras 2 columnas otra vez en desktop, usa:
      -- .stack-vertical{ grid-template-columns: 420px 1fr; }
    }
    */
  </style>
</head>
<body>
  <header>
    <a class="btn ghost" href="/">Inicio</a>
    <div class="spacer"></div>
    <a class="btn ghost" href="/employer-applications.html">Postulaciones</a>
    <button id="logoutBtn" class="btn ghost">Salir</button>
  </header>

  <main class="container">
    <h2>Vacantes</h2>

    <!-- Cambié la clase: antes era class="grid" con 2 columnas inline -->
    <div class="stack-vertical">
      <!-- ====== Caja 1: Crear vacante ====== -->
      <section class="card">
        <h3 style="margin:0 0 8px">Crear vacante</h3>
        <div class="field"><label>Título</label><input id="title" required></div>
        <div class="field"><label>Empresa (texto visible)</label><input id="company" placeholder="Mi Empresa S.A."></div>
        <div class="field"><label>NIT de empresa (para asociar)</label><input id="companyNit" placeholder="Ej: 901234567-8"></div>
        <div class="field"><label>Ubicación</label><input id="location" required></div>
        <div class="field"><label>Descripción</label><textarea id="description" required></textarea></div>
        <button class="btn" id="createBtn" type="button">Publicar</button>
        <p id="formMsg" class="msg"></p>
      </section>

      <!-- ====== Caja 2: Listado / acciones ====== -->
      <section class="card">
        <div class="grid" style="grid-template-columns:1fr auto auto;align-items:center">
          <input id="q" type="search" placeholder="Buscar…">
          <button class="btn ghost" id="refreshBtn">Actualizar</button>
          <button class="btn" id="exportBtn">Exportar CSV</button>
        </div>
        <div class="tableWrap" style="margin-top:12px">
          <table>
            <thead>
              <tr><th>ID</th><th>Título</th><th>Empresa</th><th>Ubicación</th><th>Creado</th></tr>
            </thead>
            <tbody id="tbody"></tbody>
          </table>
        </div>
        <p id="listMsg" class="msg"></p>
      </section>
    </div>
  </main>

  <script src="/assets/app.js"></script>
  <script>
    const {requireRole,qs,escapeHtml,fmtDate,fetchJSON} = App;
    requireRole('EMPLOYER','ADMIN'); App.wireHeader();
    const title=qs('#title'), company=qs('#company'), companyNit=qs('#companyNit'), locationEl=qs('#location'), description=qs('#description');
    const formMsg=qs('#formMsg'), tbody=qs('#tbody'), listMsg=qs('#listMsg'), q=qs('#q');

    function setMsg(el,txt,err=false){ el.textContent=txt||''; el.classList.toggle('err',!!err); }
    function sk(){ tbody.innerHTML=''; for(let i=0;i<6;i++){ tbody.insertAdjacentHTML('beforeend',`<tr><td colspan="5"><div class="skeleton"></div></td></tr>`)} }

    async function load(){ setMsg(listMsg,'Cargando…'); sk(); try{
      const jobs=await fetchJSON('/api/jobs'); render(jobs);
    }catch(e){ setMsg(listMsg,'❌ '+e.message,true); tbody.innerHTML=''; } }
    function render(data){
      const term=(q.value||'').toLowerCase();
      const list=term? data.filter(j=>(j.title||'').toLowerCase().includes(term)||(j.companyDisplay||j.company||'').toLowerCase().includes(term)):data;
      tbody.innerHTML=''; if(!list.length){ setMsg(listMsg,'Sin resultados'); return; }
      setMsg(listMsg,`Total: ${list.length}`);
      for(const j of list){
        tbody.insertAdjacentHTML('beforeend', `<tr>
          <td>${j.id_job??j.id}</td>
          <td>${escapeHtml(j.title||'')}</td>
          <td>${escapeHtml(j.companyDisplay||j.company||'')}</td>
          <td>${escapeHtml(j.location||'')}</td>
          <td>${escapeHtml(fmtDate(j.created_at||j.createdAt))}</td>
        </tr>`);
      }
    }
    qs('#refreshBtn').onclick=load; q.oninput=()=>load();

    qs('#createBtn').onclick=async ()=>{
      const payload={ title:title.value.trim(), location:locationEl.value.trim(), description:description.value.trim(), created_at:new Date().toISOString() };
      if(company.value.trim())    payload.company    = company.value.trim();     // visible
      if(companyNit.value.trim()) payload.companyNit = companyNit.value.trim(); // asociación
      if(!payload.title||!payload.location||!payload.description){ setMsg(formMsg,'Completa los campos',true); return; }
      try{
        setMsg(formMsg,'Publicando…');
        await fetchJSON('/api/jobs',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        setMsg(formMsg,'✅ Publicado');
        title.value=company.value=companyNit.value=locationEl.value=description.value=''; load();
      }catch(e){ setMsg(formMsg,'❌ '+e.message,true); }
    };

    qs('#exportBtn').onclick=async ()=>{
      try{
        const jobs=await fetchJSON('/api/jobs');
        const rows=[['id','title','company','location','created_at'],
          ...jobs.map(j=>[j.id_job??j.id,j.title||'',j.companyDisplay||j.company||'',j.location||'',fmtDate(j.created_at||j.createdAt)])];
        const csv=rows.map(r=>r.map(c=>{const s=String(c??'');return /[",\n]/.test(s)?`"${s.replace(/"/g,'""')}"`:s}).join(',')).join('\n');
        const blob=new Blob([csv],{type:'text/csv'}), url=URL.createObjectURL(blob);
        const a=document.createElement('a'); a.href=url; a.download='vacantes.csv'; a.click(); URL.revokeObjectURL(url);
      }catch(e){ setMsg(listMsg,'❌ '+e.message,true); }
    };

    load();
  </script>
</body>
</html>
