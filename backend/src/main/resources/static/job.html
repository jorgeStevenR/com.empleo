<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Ofertas de trabajo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/app.css">
  <style>
    /* Botón deshabilitado “Ya postulaste” */
    .btn[aria-disabled="true"]{
      opacity:.6; cursor:not-allowed; filter:grayscale(.2);
      pointer-events:none;
    }
    .section-apps{ margin-top:22px; }
    /* Botón cancelar */
    .btn.ghost.danger{ color: var(--danger); border-color: color-mix(in srgb, var(--danger) 50%, transparent); }
    .btn.ghost.danger:hover{ color:#fff; background: var(--danger); }
  </style>
</head>
<body>
  <header>
    <a class="btn ghost" href="/">Inicio</a>
    <div class="spacer"></div>
    <span id="welcome" class="muted"></span>
    <a id="empLink" class="btn ghost" href="/employer-jobs.html" style="display:none">Panel empresa</a>
    <a id="loginLink" class="btn" href="/login.html">Entrar</a>
    <!-- Botón Postulaciones (empresas) a la izquierda de Salir -->
    <a id="appsLink" class="btn ghost" href="/employer-jobs.html" style="display:none">Postulaciones</a>
    <button id="logoutBtn" class="btn ghost" style="display:none">Salir</button>
  </header>

  <main class="container">
    <h2>Ofertas de trabajo</h2>

    <div class="grid" style="grid-template-columns:1fr auto;gap:10px;align-items:center">
      <input id="q" type="search" placeholder="Buscar por título o empresa…">
      <button id="btnSearch" class="btn ghost">Buscar</button>
    </div>

    <div id="jobs" class="grid cards" style="margin-top:14px"></div>
    <p id="msg" class="msg"></p>

    <!-- Sección: Mis postulaciones (solo USER logueado) -->
    <section id="myAppsSection" class="section-apps" style="display:none">
      <h3 style="margin:14px 0 8px">Mis postulaciones</h3>
      <div id="myApps" class="grid cards"></div>
      <p id="myAppsMsg" class="msg"></p>
    </section>
  </main>

  <!-- ====== FOOTER (idéntico al index) ====== -->
  <footer class="site-footer">
    <div class="container footer-grid">
      <div class="foot-brand">
        <h3 class="brand">Portal Empleos</h3>
        <p class="muted">Conecta talento con oportunidades. Publica, busca y postula de forma simple.</p>
      </div>

      <nav class="foot-links" aria-label="Enlaces rápidos">
        <h4>Enlaces</h4>
        <ul>
          <li><a href="/">Ofertas</a></li>
          <li><a href="/employer-jobs.html">Panel empresa</a></li>
          <li><a href="/login.html">Entrar</a></li>
        </ul>
      </nav>

      <div class="foot-contact">
        <h4>Contacto</h4>
        <ul>
          <li><a href="mailto:soporte@portalempleos.test">soporte@portalempleos.test</a></li>
          <li class="muted">Lun–Vie · 9:00–18:00</li>
        </ul>
      </div>
    </div>

    <div class="footer-legal">
      <div class="container legal-row">
        <small>© <span id="year"></span> Portal Empleos. Todos los derechos reservados.</small>
        <div class="legal-links">
          <a href="/politica-privacidad.html">Privacidad</a>
          <a href="/terminos.html">Términos</a>
        </div>
      </div>
    </div>
  </footer>
  <!-- ====== /FOOTER ====== -->

  <script src="/assets/app.js"></script>
  <script>
    // Año del footer
    document.getElementById('year').textContent = new Date().getFullYear();

    const { qs, escapeHtml, fetchJSON, wireHeader, getUser, role } = App;
    wireHeader();

    // Mostrar/ocultar botón Postulaciones (empresas) según rol y sesión
    const u = getUser();
    const appsLink = qs('#appsLink');
    if (u && (role() === 'EMPLOYER' || role() === 'ADMIN')) {
      appsLink.style.display = 'inline-block';
    } else {
      appsLink.style.display = 'none';
    }

    // Helpers de aplicaciones (antiduplicado + cancelación)
    const userId = (u && (u.id || u.userId || u.email)) || null;
    const LS_KEY = userId ? `applied:${userId}` : null;

    function loadAppliedFromLS(){
      if(!LS_KEY) return new Set();
      try{
        const raw = localStorage.getItem(LS_KEY);
        const arr = raw ? JSON.parse(raw) : [];
        return new Set(arr);
      }catch{ return new Set(); }
    }
    function saveAppliedToLS(set){
      if(!LS_KEY) return;
      try{ localStorage.setItem(LS_KEY, JSON.stringify([...set])); }catch{}
    }

    // API opcional
    async function fetchMyApplicationsFromAPI(){
      try{
        const data = await fetchJSON('/api/my-applications');
        const ids = (Array.isArray(data) ? data : []).map(a => a.jobId ?? a.job_id ?? a.id_job ?? a.id).filter(Boolean);
        return new Set(ids);
      }catch{ return null; }
    }
    async function deleteApplicationAPI(jobId){
      const url = `/api/my-applications/${encodeURIComponent(jobId)}`;
      try{
        const res = await fetch(url, { method:'DELETE' });
        if(!res.ok) throw new Error('DELETE falló');
        return true;
      }catch{ return false; }
    }

    // Estado
    let appliedSet = loadAppliedFromLS();
    let allJobsData = [];       // cache de empleos
    let currentFilter = '';     // texto de búsqueda actual

    const jobsEl = qs('#jobs'), msg = qs('#msg'), q = qs('#q'), btn = qs('#btnSearch');
    const myAppsSection = qs('#myAppsSection'), myAppsEl = qs('#myApps'), myAppsMsg = qs('#myAppsMsg');

    async function hydrateAppliedSet(){
      if(!u) return;
      const fromApi = await fetchMyApplicationsFromAPI();
      if(fromApi){
        appliedSet = new Set([...appliedSet, ...fromApi]);
        saveAppliedToLS(appliedSet);
      }
    }

    function renderMyApplications(){
      if(!(u && role()==='USER')){ myAppsSection.style.display='none'; return; }
      const appliedJobs = allJobsData.filter(j => appliedSet.has(String(j.id_job ?? j.id)));
      myAppsSection.style.display = 'block';
      myAppsEl.innerHTML = '';
      if(!appliedJobs.length){
        myAppsMsg.textContent = 'Aún no has postulado a ninguna oferta.';
        return;
      }
      myAppsMsg.textContent = `Total: ${appliedJobs.length}`;
      for(const j of appliedJobs){
        const id = j.id_job ?? j.id;
        const card = document.createElement('div');
        card.className = 'card';
        card.innerHTML = `
          <h4 style="margin:0 0 6px">${escapeHtml(j.title||'')}</h4>
          <p class="muted" style="margin:0 0 8px">${escapeHtml(j.companyDisplay||j.company||'')} — ${escapeHtml(j.location||'')}</p>
          <div style="display:flex; gap:8px; flex-wrap:wrap">
            <a class="btn ghost" href="/apply.html?jobId=${encodeURIComponent(id)}">Ver detalle</a>
            <button class="btn ghost danger cancel-btn" data-job-id="${escapeHtml(String(id))}">Cancelar postulación</button>
          </div>
        `;
        myAppsEl.appendChild(card);
      }

      // Bind a botones cancelar
      for(const b of myAppsEl.querySelectorAll('.cancel-btn')){
        b.addEventListener('click', async ()=>{
          const jobId = b.getAttribute('data-job-id');
          // 1) Intento con API
          let ok = await deleteApplicationAPI(jobId);
          // 2) Fallback local si falla
          appliedSet.delete(String(jobId));
          saveAppliedToLS(appliedSet);
          // Re-render
          renderJobs(filterJobs(allJobsData, currentFilter), allJobsData);
          renderMyApplications();
        });
      }
    }

    function renderJobs(list, allJobs){
      jobsEl.innerHTML='';
      for(const j of list){
        const id = j.id_job ?? j.id;
        const comp = j.companyDisplay || j.company || '';
        const r = role();
        const already = appliedSet.has(String(id));

        const postHref = (!already && getUser() && r==='USER')
          ? `/apply.html?jobId=${encodeURIComponent(id)}`
          : `/login.html?next=${encodeURIComponent('/apply.html?jobId='+id)}`;

        const card=document.createElement('div'); card.className='card';
        card.innerHTML = `
          <h3 style="margin:0">${escapeHtml(j.title||'')}</h3>
          <p class="muted">${escapeHtml(comp)} — ${escapeHtml(j.location||'')}</p>
          <p>${escapeHtml(j.description||'')}</p>
          <div style="display:flex; gap:8px; margin-top:auto; flex-wrap:wrap">
            ${
              r==='USER'
              ? (already
                  ? `<a class="btn" aria-disabled="true">Ya postulaste</a>`
                  : `<a class="btn apply-btn" data-job-id="${escapeHtml(String(id))}" href="${postHref}">Postular</a>`
                )
              : `<a class="btn" href="${postHref}">${getUser() ? 'Postular' : 'Entrar para postular'}</a>`
            }
            ${r==='EMPLOYER'||r==='ADMIN'?`<a class="btn ghost" href="/employer-applications.html">Ver postulaciones</a>`:''}
          </div>`;
        jobsEl.appendChild(card);
      }

      // Interceptar “Postular” para bloquear duplicados
      for(const a of document.querySelectorAll('.apply-btn')){
        a.addEventListener('click', (ev)=>{
          const jobId = a.getAttribute('data-job-id');
          if(appliedSet.has(String(jobId))){
            ev.preventDefault();
            return;
          }
          appliedSet.add(String(jobId));
          saveAppliedToLS(appliedSet);
          // feedback rápido
          a.setAttribute('aria-disabled','true');
          a.textContent = 'Ya postulaste';
          a.removeAttribute('href');
          a.classList.remove('apply-btn');
          // actualizar panel
          renderMyApplications();
        });
      }
    }

    function filterJobs(data, term){
      const listTxt = (term||'').toLowerCase();
      return listTxt
        ? data.filter(j=> (j.title||'').toLowerCase().includes(listTxt)
                       || (j.companyDisplay||j.company||'').toLowerCase().includes(listTxt))
        : data;
    }

    async function loadJobs(term=''){
      msg.textContent='Cargando…'; jobsEl.innerHTML='';
      try{
        await hydrateAppliedSet();
        allJobsData = await fetchJSON('/api/jobs');
        currentFilter = term;
        const filtered = filterJobs(allJobsData, term);

        if(!filtered.length){
          msg.textContent = term ? 'Sin resultados.' : 'No hay ofertas aún.';
        }else{
          msg.textContent=`Total: ${filtered.length}${term?' (filtrado)':''}`;
        }

        renderJobs(filtered, allJobsData);
        renderMyApplications();
      }catch(e){
        msg.textContent='Error: '+e.message; msg.classList.add('err');
      }
    }

    btn.addEventListener('click', ()=> loadJobs(q.value));
    q.addEventListener('keydown', e=>{ if(e.key==='Enter') loadJobs(q.value); });
    loadJobs();
  </script>
</body>
</html>
