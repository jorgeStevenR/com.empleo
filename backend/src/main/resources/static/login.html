<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <title>Iniciar sesión</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/app.css">
  <style>
    :root { --bg1:#f7f8fc; --bg2:#eef2ff; --ink:#0f172a; --muted:#6b7280; --brand:#2563eb; }
    *{box-sizing:border-box}
    body{
      margin:0; min-height:100vh; display:grid; place-items:center;
      background: radial-gradient(80% 60% at 50% 0%, var(--bg2) 0%, var(--bg1) 50%, #f5f6fa 100%);
      font-family: system-ui, -apple-system, "Segoe UI", Roboto, Inter, Arial, sans-serif;
      color:var(--ink);
    }
    .auth{ width:min(460px, 92vw); padding:22px 20px 18px; border-radius:18px; background:#fff;
           box-shadow: 0 30px 60px rgba(15,23,42,.08), 0 2px 10px rgba(15,23,42,.05); border: 1px solid #eef1f6; }
    h1{ margin:0 0 14px; font-size:24px; letter-spacing:.2px }
    .field{ display:grid; gap:6px; margin:10px 0 }
    .field label{ font-size:13px; color:var(--muted) }
    input{ width:100%; padding:12px 12px; border-radius:12px; border:1px solid #e6e9f2; outline:none; font-size:15px; background:#fbfcff;
           transition: box-shadow .15s, border-color .15s, background .15s; }
    input:focus{ border-color:#c7d2fe; box-shadow:0 0 0 4px #e5edff }
    .actions{ display:flex; gap:10px; justify-content:space-between; align-items:center; margin-top:8px; }
    .btn{ border:0; padding:10px 14px; border-radius:12px; font-weight:700; cursor:pointer; background:var(--brand); color:#fff; transition:transform .06s ease; }
    .btn:active{ transform:translateY(1px) }
    .ghost{ background:#fff; color:var(--brand); border:1px solid #dbe4ff; }
    .btn:disabled{ opacity:.7; cursor:wait }
    .msg{ min-height:18px; margin-top:8px; font-size:13px; color:#374151 }
    .msg.err{ color:#b91c1c }
    .seg{display:flex;gap:8px;background:color-mix(in srgb,var(--card) 80%, transparent);
         border:1px solid var(--border); padding:6px; border-radius:12px; width:max-content; margin-bottom:10px}
    .seg button{border:none;background:transparent;padding:10px 14px;border-radius:8px;cursor:pointer;font-weight:700}
    .seg button.active{background:linear-gradient(180deg,var(--primary),var(--primary-600));color:#fff}
  </style>
</head>
<body>

  <form id="form" class="auth" novalidate>
    <h1>Iniciar sesión</h1>

    <div class="seg" role="tablist" aria-label="Tipo de cuenta">
      <button type="button" id="segUser" class="active" aria-selected="true">Candidato</button>
      <button type="button" id="segEmp">Empresa</button>
    </div>

    <div class="field">
      <label id="lblUser">Email</label>
      <input id="email" type="text" required autocomplete="username" placeholder="tu@correo.com">
    </div>

    <div class="field">
      <label>Contraseña</label>
      <input id="password" type="password" required autocomplete="current-password" placeholder="••••••••">
    </div>

    <div class="actions">
      <a class="btn ghost" href="/register.html">Crear cuenta</a>
      <button id="btn" class="btn" type="submit">Entrar</button>
    </div>

    <p id="msg" class="msg" aria-live="polite"></p>

    <div class="foot">
      <div class="links">
        <a href="/register.html?role=USER">registrarme como usuario</a>
        <a href="/register.html?role=EMPLOYER">registrarme como empresa</a>
      </div>
    </div>
  </form>

  <script src="/assets/app.js"></script>
  <script>
    const { setUser, qs } = App;
    const form = qs('#form'), msg = qs('#msg'), btn = qs('#btn');
    const segUser=qs('#segUser'), segEmp=qs('#segEmp'), lblUser=qs('#lblUser');
    let isEmpresa = false;

    function setMode(emp){
      isEmpresa = emp;
      segUser.classList.toggle('active', !emp);
      segEmp.classList.toggle('active', emp);
      lblUser.textContent = emp ? 'NIT o Email de empresa' : 'Email';
      qs('#email').placeholder = emp ? 'NIT o email' : 'tu@correo.com';
    }

    const t = (new URL(location.href)).searchParams.get('type') || (new URL(location.href)).searchParams.get('role');
    setMode((t||'USER').toUpperCase()==='EMPLOYER');

    segUser.onclick = ()=> setMode(false);
    segEmp.onclick  = ()=> setMode(true);

    const redirectByRole = (role)=>{
      const r=(role||'USER').toUpperCase();
      if (r==='EMPLOYER') return '/employer-jobs.html';
      if (r==='ADMIN')    return '/users.html';
      return '/job.html';
    };

    form.addEventListener('submit', async (e)=>{
      e.preventDefault();
      const emailOrNit = qs('#email').value.trim();
      const password = qs('#password').value;
      if (!emailOrNit || !password){ msg.textContent='Completa los campos.'; msg.classList.remove('err'); return; }
      btn.disabled = true; msg.textContent = 'Verificando…'; msg.classList.remove('err');

      try{
        const url = isEmpresa ? '/api/companies/login' : '/api/users/login';
        const body = isEmpresa ? { username: emailOrNit, password } : { email: emailOrNit, password };

        const res = await fetch(url, {
          method:'POST', headers:{'Content-Type':'application/json'},
          body: JSON.stringify(body)
        });
        const ct = (res.headers.get('content-type')||'').toLowerCase();
        if (!ct.includes('application/json')) throw new Error('El servidor no envió JSON');
        const data = await res.json();
        if (!res.ok || data.ok !== true) throw new Error(data?.message || ('HTTP '+res.status));

        setUser(data.user || null);
        if (data.token) localStorage.setItem('token', data.token);

        msg.textContent = '✅ Login exitoso. Redirigiendo…';
        const next=new URL(location.href).searchParams.get('next');
        setTimeout(()=>location.replace(next || redirectByRole(data.user?.role)), 400);
      }catch(err){
        msg.textContent = '❌ ' + err.message;
        msg.classList.add('err');
      }finally{
        btn.disabled = false;
      }
    });
  </script>
</body>
</html>
