<!doctype html>
<html lang="es">
<head>
  <meta charset="utf-8" />
  <title>Empresas</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <link rel="stylesheet" href="/assets/app.css">
</head>
<body>
  <header>
    <a class="btn ghost" href="/">Inicio</a><div class="spacer"></div>
    <button id="logoutBtn" class="btn ghost">Salir</button>
  </header>

  <main class="container">
    <h2>Empresas</h2>
    <div class="grid" style="grid-template-columns:420px 1fr">
      <section class="card">
        <h3 style="margin:0 0 8px">Crear empresa</h3>
        <div class="field"><label>Nombre</label><input id="name" required></div>
        <div class="field"><label>NIT</label><input id="nit" required placeholder="Ej: 901234567-8"></div>
        <div class="field"><label>Website</label><input id="website" placeholder="https://…"></div>
        <div class="field"><label>Ubicación</label><input id="location"></div>
        <div class="field"><label>Descripción</label><textarea id="description"></textarea></div>
        <button class="btn" id="createBtn" type="button">Guardar</button>
        <p class="msg" id="formMsg"></p>
      </section>

      <section class="card">
        <div class="grid" style="grid-template-columns:1fr auto;align-items:center">
          <input id="q" type="search" placeholder="Buscar…">
          <button id="refreshBtn" class="btn ghost">Actualizar</button>
        </div>
        <div class="tableWrap" style="margin-top:12px">
          <table><thead><tr><th>ID</th><th>NIT</th><th>Nombre</th><th>Website</th><th>Ubicación</th><th>Creado</th></tr></thead><tbody id="tbody"></tbody></table>
        </div>
        <p class="msg" id="listMsg"></p>
      </section>
    </div>
  </main>

  <script src="/assets/app.js"></script>
  <script>
    const {requireRole,qs,escapeHtml,fmtDate,fetchJSON} = App;
    requireRole('EMPLOYER','ADMIN'); App.wireHeader();
    const name=qs('#name'), nit=qs('#nit'), website=qs('#website'), locationEl=qs('#location'), description=qs('#description');
    const formMsg=qs('#formMsg'), tbody=qs('#tbody'), listMsg=qs('#listMsg'), q=qs('#q');

    function setMsg(el,txt,err=false){ el.textContent=txt||''; el.classList.toggle('err',!!err); }

    async function load(){ listMsg.textContent='Cargando…'; tbody.innerHTML='<tr><td colspan="6"><div class="skeleton"></div></td></tr>';
      try{
        const data=await fetchJSON('/api/companies');
        render(data);
      }catch(e){ setMsg(listMsg,'❌ '+e.message,true); tbody.innerHTML=''; }
    }
    function render(data){
      const term=(q.value||'').toLowerCase();
      const list=term? data.filter(c=>(c.name||'').toLowerCase().includes(term)||(c.nit||'').toLowerCase().includes(term)||(c.location||'').toLowerCase().includes(term)):data;
      tbody.innerHTML=''; if(!list.length){ listMsg.textContent='Sin resultados'; return; }
      listMsg.textContent='Total: '+list.length;
      for(const c of list){
        tbody.insertAdjacentHTML('beforeend', `<tr>
          <td>${c.idCompany??c.id}</td>
          <td>${escapeHtml(c.nit||'')}</td>
          <td>${escapeHtml(c.name||'')}</td>
          <td>${c.website?`<a href="${escapeHtml(c.website)}" target="_blank">${escapeHtml(c.website)}</a>`:''}</td>
          <td>${escapeHtml(c.location||'')}</td>
          <td>${escapeHtml(fmtDate(c.createdAt))}</td>
        </tr>`);
      }
    }

    qs('#createBtn').onclick=async ()=>{
      const payload={ name:name.value.trim(), nit:nit.value.trim(), website:website.value.trim(), location:locationEl.value.trim(), description:description.value.trim() };
      if(!payload.name || !payload.nit){ setMsg(formMsg,'Nombre y NIT son obligatorios',true); return; }
      try{
        setMsg(formMsg,'Guardando…');
        await fetchJSON('/api/companies',{method:'POST',headers:{'Content-Type':'application/json'},body:JSON.stringify(payload)});
        setMsg(formMsg,'✅ Creada');
        name.value=nit.value=website.value=locationEl.value=description.value=''; load();
      }catch(e){ setMsg(formMsg,'❌ '+e.message,true); }
    };
    qs('#refreshBtn').onclick=load; q.oninput=load; load();
  </script>
</body>
</html>
